import{r as v,j as L}from"./khl8ktun31iepecq.js";import{mt as oe,mu as H,mv as X,mw as le,g4 as ce,ad as ue,gR as de,eD as pe,ec as me,g8 as he,gt as fe,mx as ge,my as ve,mz as we,mA as Se,a5 as ye,mB as Me,go as xe,gn as Te,mC as Ce,df as be,eP as Ee,mD as De}from"./n4exq6o15ap1g74l.js";import{aF as Pe,dM as He,h1 as ke,o as Ie,n as Ae,a_ as Fe,aj as Re,l as Oe,aG as Ke,E as Le,cI as _e,F as ze}from"./haannt40upmuwmtk.js";import{a as x,P as C,D as Ne,b as qe,T as R,p as Ue,M as je,k as _,d as W,S as Ge,E as We,e as Be,g as $e,i as Qe,n as Ve,h as Je}from"./dfz2bdgqh4yduujb.js";const Y=new x("transactionEventPlugin"),z="prosemirrorDispatchTransaction";function B(n,e){const{eventTarget:t}=Y.getState(n.state);return t.addEventListener(z,e),()=>{t.removeEventListener(z,e)}}function Xe(n){return new C({key:Y,state:{init(){return{eventTarget:n}},apply(e,t){return t}}})}const k=new x("customKeymapPlugin");function Ye(n,e){n.dispatch(n.state.tr.setMeta(k,{handlers:e}))}function Ze(n={handlers:{}}){return new C({key:k,state:{init(){return{...n}},apply(e,t){const s=e.getMeta(k);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){const i=k.getState(e.state).handlers[t.key];return i?i(t):!1}}})}const y=new x("menuSelectorPlugin");function $(n){n.dispatch(n.state.tr.setMeta(y,{active:!1,onMenuAction:void 0}))}function Pt(n,e){n.dispatch(n.state.tr.setMeta(y,{active:!0,onMenuAction:e}))}function et(n={submitKeys:["Enter","Tab"],cancelKeys:["Escape"],checkStrictMatchKeys:[" "]}){return new C({key:y,state:{init(){return{...n,active:!1}},apply(e,t){const s=e.getMeta(y);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){const s=y.getState(e.state);if(!s.active)return!1;if(!t.isComposing)return s.submitKeys.includes(t.key)?(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),$(e),s.onMenuAction?.("submit")??!0):s.cancelKeys.includes(t.key)?(t.preventDefault(),s.onMenuAction?.("cancel"),$(e),!0):t.key==="ArrowUp"?(t.preventDefault(),s.onMenuAction?.("up"),!0):t.key==="ArrowDown"?(t.preventDefault(),s.onMenuAction?.("down"),!0):s.checkStrictMatchKeys.includes(t.key)&&s.onMenuAction?.("checkMatch")?(t.preventDefault(),!0):!1},handleDOMEvents:{blur:e=>{y.getState(e.state).onMenuAction?.("cancel")}}}})}const E=new x("placeholderPlugin");function tt(n){return new C({key:E,state:{init(){return{placeholder:n}},apply(e,t){return e.getMeta(E)?{placeholder:e.getMeta(E).placeholder}:t}},props:{decorations(e){const{doc:t}=e;if(t.childCount===1&&t.firstChild?.isTextblock&&t.firstChild.content.size===0){const i=[],{placeholder:r}=E.getState(e);return e.doc.descendants((a,l)=>{const o=Ne.node(l,l+a.nodeSize,{class:"placeholder","data-placeholder":r});i.push(o)}),qe.create(t,i)}}}})}const D="command_token",nt={group:"inline",inline:!0,atom:!0,content:"text*",attrs:{id:"",hint:""},selectable:!1,draggable:!1,toDOM:n=>["span",{"data-mention-id":n.attrs.id,"data-mention-hint":n.attrs.hint,class:"hint-pill"},n.attrs.hint],parseDOM:[{tag:"span[data-mention-id][data-mention-hint]",getAttrs:n=>{const e=n.getAttribute("data-mention-id"),t=n.getAttribute("data-mention-hint");return{id:e,hint:t}}}]};function Z(n,e){if(n.depth===0)return;const t=n.nodeBefore?.text?.match(/(?:^|\s)(\/(\w*))$/);if(t?.[1].length!==void 0){const s=n.pos-t[1].length,i=n.pos,r=s===e?.from;return{range:{from:s,to:i},queryText:t[2],isDismissed:r}}}const N=new x("systemHintPlugin");function ee(n,e){return n.setMeta(N,e),n}function Ht(n){const t=n.state.selection.$from,s=Z(t,void 0);n.dispatch(ee(n.state.tr,{...A(),dismissedRange:s?.range}))}function A(){return{queryText:"",active:!1,range:void 0,dismissedRange:void 0}}function st(n,e,t,s,i){const r=n.state.tr;ee(r,A());const a=t+" ",l=n.state.schema.nodes[D].create({id:e,hint:a},n.state.schema.text(a));if(i===s){const o=r.doc.resolve(s).nodeAfter;if(o?.isText){const c=o?.textContent.match(new RegExp(`^(?:${t}) ?`));c&&(i=s+c[0].length)}}r.replaceWith(s,i,l),r.doc.descendants((o,c)=>{o.type.name===D&&o!==l&&(s===1&&c===s+l.nodeSize||c===1&&s===c+o.nodeSize?r.delete(c,c+o.nodeSize):r.insertText(o.textContent,c,c+o.nodeSize))}),n.dispatch(r)}function it(n){const e=n.state.tr;e.doc.descendants((t,s)=>{if(t.type.name===D){const i=s+t.nodeSize;s===1&&e.doc.resolve(i).nodeAfter==null?e.delete(s,i):e.insertText(t.textContent,s,s+t.nodeSize)}}),e.steps.length>0&&n.dispatch(e)}function Q(n){const{active:e,range:t,queryText:s,onHintMatch:i}=n;if(i)return i(!e||!t?void 0:{text:s,range:t})}function rt(n){const e=[];return n.descendants(t=>{t.type.name===D&&typeof t.attrs?.id=="string"&&e.push(t.attrs.id)}),e}function at(){return new C({key:N,state:{init(){return A()},apply(n,e,t,s){const i=n.getMeta(N),r={...A(),...e,...i},a=n.selection;if(a.from!==a.to||s.doc.eq(t.doc))return Q(r),r;const l=a.$from,o=Z(l,e.dismissedRange);return r.active=!!o&&!o.isDismissed,o&&(r.queryText=o.queryText,r.range=o.range,o.isDismissed&&(o.queryText===""&&e.queryText!==""?r.dismissedRange=void 0:r.dismissedRange=o.range)),Q(r),r}}})}class ot extends oe{constructor(e){super(),this.view=e,this.subscribe("focus",()=>this._store.setState({isFocused:!0})),this.subscribe("blur",()=>this._store.setState({isFocused:!1}))}fileInputHandle=null;_store=Pe(e=>({isFocused:!1,autocompletions:[],showTaggingDropdown:!1,waveWidth:300,isInReasonMode:!1,setShowTaggingDropdown:t=>e({showTaggingDropdown:t})}));get store(){return this._store}_usedDictation=!1;get usedDictation(){return this._usedDictation}set usedDictation(e){this._usedDictation=e}get element(){return this.view.dom}get document(){return this.view.dom.ownerDocument}isEmpty(){return this.view.state.doc.textContent.trim().length===0}isFocused(){return this.view.hasFocus()}trimLeadingText(e){const s=this.view.state.tr;let i=0;return s.doc.descendants((r,a)=>{if(r.isText&&r.text){if(typeof e=="string"&&r.text.startsWith(e))i=e.length;else if(e instanceof RegExp){const l=r.text.match(e);l?.index===0&&(i=l[0].length)}if(i){const l=r.text.substring(i).trimStart();i=r.text.length-l.length,s.delete(a,a+i)}}return!r.isLeaf}),i>0?(this.view.dispatch(s),!0):!1}replaceAll(e,t){const i=this.view.state.tr,r=[];i.doc.descendants((a,l)=>{!a.isText||a.text===void 0||r.push({node:a,pos:l})}),r.reverse(),r.forEach(({node:a,pos:l})=>{!a.isText||a.text===void 0||a.text.includes(e)&&i.insertText(a.text.replaceAll(e,t),l,l+a.text.length)}),this.view.dispatch(i)}appendText(e){this.view.dispatch(this.view.state.tr.insertText(e))}delete(e,t){this.view.dispatch(this.view.state.tr.delete(e,t))}focus(){this.view.hasFocus()||(this.view.focus(),this.view.dispatch(this.view.state.tr.setSelection(R.atEnd(this.view.state.doc)).scrollIntoView()))}setText(e){const{tr:t,schema:s}=this.view.state,i=e?s.nodes.paragraph.create(null,s.text(e)):s.nodes.paragraph.create();this.view.dispatch(t.replaceWith(0,this.view.state.doc.content.size,i)),this.view.hasFocus()&&this.view.dispatch(this.view.state.tr.setSelection(R.atEnd(this.view.state.doc)))}getContentLength(){return this.view.state.doc.content.size}getCurrentText(){return this.view.state.doc.textContent}hasMultipleLines(){let e=0;return this.view.state.doc.descendants(t=>{t.isBlock&&e++}),e>1}getContentToSend(){return Ue(this.view)}resize(){}isReady(){return!!this.view.state.doc}setPlaceholder(e){this.view.dispatch(this.view.state.tr.setMeta(E,{placeholder:e}))}getSelectionStart(){return this.view.state.selection.ranges[0].$from.pos}setSelection(e,t){this.view.dispatch(this.view.state.tr.setSelection(R.create(this.view.state.doc,e,t))),this.view.focus()}isMenuSelectorActive(){return y.getState(this.view.state).active}registerKeyHandlers(e){Ye(this.view,e)}registerFileInput(e){this.fileInputHandle=e}openFileDialog(){this.fileInputHandle?.openFileDialog()}acceptLegacyKeydown(){return!1}subscribe(e,t){if(e==="change"){const s=()=>t(void 0);return B(this.view,s)}return this.view.dom?.addEventListener(e,t,{capture:!0}),()=>{this.view.dom?.removeEventListener(e,t,{capture:!0})}}useState(e){return v.useSyncExternalStore(t=>B(this.view,t),()=>e(this),()=>e(this))}getSystemHint(){return rt(this.view.state.tr.doc)[0]??null}addSystemHint(e,t,s=1,i=1){st(this.view,e,t,s,i)}removeSystemHints(){it(this.view)}canShowAutocompletion(){return this.getSystemHint()===H.PictureV2||!this.isMenuSelectorActive()&&!this.getSystemHint()}}const lt=500;class f{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let s=this.items.length;for(;;s--)if(this.items.get(s-1).selection){--s;break}let i,r;t&&(i=this.remapping(s,this.items.length),r=i.maps.length);let a=e.tr,l,o,c=[],p=[];return this.items.forEach((d,u)=>{if(!d.step){i||(i=this.remapping(s,u+1),r=i.maps.length),r--,p.push(d);return}if(i){p.push(new g(d.map));let m=d.step.map(i.slice(r)),h;m&&a.maybeStep(m).doc&&(h=a.mapping.maps[a.mapping.maps.length-1],c.push(new g(h,void 0,void 0,c.length+p.length))),r--,h&&i.appendMap(h,r)}else a.maybeStep(d.step);if(d.selection)return l=i?d.selection.map(i.slice(r)):d.selection,o=new f(this.items.slice(0,s).append(p.reverse().concat(c)),this.eventCount-1),!1},this.items.length,0),{remaining:o,transform:a,selection:l}}addTransform(e,t,s,i){let r=[],a=this.eventCount,l=this.items,o=!i&&l.length?l.get(l.length-1):null;for(let p=0;p<e.steps.length;p++){let d=e.steps[p].invert(e.docs[p]),u=new g(e.mapping.maps[p],d,t),m;(m=o&&o.merge(u))&&(u=m,p?r.pop():l=l.slice(0,l.length-1)),r.push(u),t&&(a++,t=void 0),i||(o=u)}let c=a-s.depth;return c>ut&&(l=ct(l,c),a-=c),new f(l.append(r),a)}remapping(e,t){let s=new je;return this.items.forEach((i,r)=>{let a=i.mirrorOffset!=null&&r-i.mirrorOffset>=e?s.maps.length-i.mirrorOffset:void 0;s.appendMap(i.map,a)},e,t),s}addMaps(e){return this.eventCount==0?this:new f(this.items.append(e.map(t=>new g(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let s=[],i=Math.max(0,this.items.length-t),r=e.mapping,a=e.steps.length,l=this.eventCount;this.items.forEach(u=>{u.selection&&l--},i);let o=t;this.items.forEach(u=>{let m=r.getMirror(--o);if(m==null)return;a=Math.min(a,m);let h=r.maps[m];if(u.step){let T=e.steps[m].invert(e.docs[m]),w=u.selection&&u.selection.map(r.slice(o+1,m));w&&l++,s.push(new g(h,T,w))}else s.push(new g(h))},i);let c=[];for(let u=t;u<a;u++)c.push(new g(r.maps[u]));let p=this.items.slice(0,i).append(c).append(s),d=new f(p,l);return d.emptyItemCount()>lt&&(d=d.compress(this.items.length-s.length)),d}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){let t=this.remapping(0,e),s=t.maps.length,i=[],r=0;return this.items.forEach((a,l)=>{if(l>=e)i.push(a),a.selection&&r++;else if(a.step){let o=a.step.map(t.slice(s)),c=o&&o.getMap();if(s--,c&&t.appendMap(c,s),o){let p=a.selection&&a.selection.map(t.slice(s));p&&r++;let d=new g(c.invert(),o,p),u,m=i.length-1;(u=i.length&&i[m].merge(d))?i[m]=u:i.push(d)}}else a.map&&s--},this.items.length,0),new f(X.from(i.reverse()),r)}}f.empty=new f(X.empty,0);function ct(n,e){let t;return n.forEach((s,i)=>{if(s.selection&&e--==0)return t=i,!1}),n.slice(t)}class g{constructor(e,t,s,i){this.map=e,this.step=t,this.selection=s,this.mirrorOffset=i}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new g(t.getMap().invert(),t,this.selection)}}}class S{constructor(e,t,s,i,r){this.done=e,this.undone=t,this.prevRanges=s,this.prevTime=i,this.prevComposition=r}}const ut=20;function dt(n,e,t,s){let i=t.getMeta(M),r;if(i)return i.historyState;t.getMeta(ht)&&(n=new S(n.done,n.undone,null,0,-1));let a=t.getMeta("appendedTransaction");if(t.steps.length==0)return n;if(a&&a.getMeta(M))return a.getMeta(M).redo?new S(n.done.addTransform(t,void 0,s,I(e)),n.undone,V(t.mapping.maps),n.prevTime,n.prevComposition):new S(n.done,n.undone.addTransform(t,void 0,s,I(e)),null,n.prevTime,n.prevComposition);if(t.getMeta("addToHistory")!==!1&&!(a&&a.getMeta("addToHistory")===!1)){let l=t.getMeta("composition"),o=n.prevTime==0||!a&&n.prevComposition!=l&&(n.prevTime<(t.time||0)-s.newGroupDelay||!pt(t,n.prevRanges)),c=a?O(n.prevRanges,t.mapping):V(t.mapping.maps);return new S(n.done.addTransform(t,o?e.selection.getBookmark():void 0,s,I(e)),f.empty,c,t.time,l??n.prevComposition)}else return(r=t.getMeta("rebased"))?new S(n.done.rebased(t,r),n.undone.rebased(t,r),O(n.prevRanges,t.mapping),n.prevTime,n.prevComposition):new S(n.done.addMaps(t.mapping.maps),n.undone.addMaps(t.mapping.maps),O(n.prevRanges,t.mapping),n.prevTime,n.prevComposition)}function pt(n,e){if(!e)return!1;if(!n.docChanged)return!0;let t=!1;return n.mapping.maps[0].forEach((s,i)=>{for(let r=0;r<e.length;r+=2)s<=e[r+1]&&i>=e[r]&&(t=!0)}),t}function V(n){let e=[];for(let t=n.length-1;t>=0&&e.length==0;t--)n[t].forEach((s,i,r,a)=>e.push(r,a));return e}function O(n,e){if(!n)return null;let t=[];for(let s=0;s<n.length;s+=2){let i=e.map(n[s],1),r=e.map(n[s+1],-1);i<=r&&t.push(i,r)}return t}function mt(n,e,t){let s=I(e),i=M.get(e).spec.config,r=(t?n.undone:n.done).popEvent(e,s);if(!r)return null;let a=r.selection.resolve(r.transform.doc),l=(t?n.done:n.undone).addTransform(r.transform,e.selection.getBookmark(),i,s),o=new S(t?l:r.remaining,t?r.remaining:l,null,0,-1);return r.transform.setSelection(a).setMeta(M,{redo:t,historyState:o})}let K=!1,J=null;function I(n){let e=n.plugins;if(J!=e){K=!1,J=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){K=!0;break}}return K}const M=new x("history"),ht=new x("closeHistory");function ft(n={}){return n={depth:n.depth||100,newGroupDelay:n.newGroupDelay||500},new C({key:M,state:{init(){return new S(f.empty,f.empty,null,0,-1)},apply(e,t,s){return dt(t,s,e,n)}},config:n,props:{handleDOMEvents:{beforeinput(e,t){let s=t.inputType,i=s=="historyUndo"?ne:s=="historyRedo"?q:null;return i?(t.preventDefault(),i(e.state,e.dispatch)):!1}}}})}function te(n,e){return(t,s)=>{let i=M.getState(t);if(!i||(n?i.undone:i.done).eventCount==0)return!1;if(s){let r=mt(i,t,n);r&&s(e?r.scrollIntoView():r)}return!0}}const ne=te(!1,!0),q=te(!0,!0);function gt(){return _({"Shift-Enter":(n,e)=>W(n,e),Enter:(n,e)=>window.innerWidth>le[ce.Medium]||He?!1:W(n,e)})}const vt=["p",0],wt=["br"],St=new Ge({nodes:{paragraph:{content:"inline*",group:"block",parseDOM:[{tag:"p",preserveWhitespace:"full"}],toDOM(){return vt}},text:{group:"inline"},hard_break:{inline:!0,group:"inline",selectable:!1,parseDOM:[{tag:"br"}],toDOM(){return wt}},[D]:nt,doc:{content:"block+"}},marks:{}});function yt(n=null){const e=new EventTarget,t=new We(null,{state:Be.create({schema:St,plugins:[ft(),et(),tt(""),at(),gt(),_({"Mod-z":ne,"Mod-y":q,"Mod-Shift-z":q}),Ze(),_(Je),Xe(e),$e()]}),dispatchTransaction(s){const i=t.state.apply(s);t.updateState(i),s.docChanged&&e.dispatchEvent(new Event(z))},handlePaste(s,i){const r=i.clipboardData?.getData("text/plain");return r===void 0?!1:(i.defaultPrevented||Qe(s,r),!0)},clipboardTextSerializer(s){return Ve(s.content).content}});return n!=null&&t.state.doc.textContent.trim().length===0&&t.dispatch(t.state.tr.insertText(n)),t}const U=v.createContext(null),Mt=({children:n,clientThreadId:e,ignoreParentComposerController:t=!1})=>{const s=v.useContext(U),i=v.useMemo(()=>s&&!t?s:new ot(yt(ke(Ie(e))?.content??null)),[s,e]);return L.jsx(U.Provider,{value:i,children:n})},kt=()=>Ae(v.useContext(U));function se(){return{clientThreadId:"",isLoggedInUser:!1,focusedObject:null,currentModelId:"",isModelLoaded:!1,isEmbeddedInFocusedView:!1,isInstalledApp:!1,onNewThread:()=>{throw new Error("onNewThread not implemented")},onRequestCompletion:()=>{throw new Error("onRequestCompletion not implemented")},resetThread:()=>{throw new Error("resetThread not implemented")}}}const ie=v.createContext(se());function xt(){try{return v.use(ie)}catch{return se()}}function It({children:n,clientThreadId:e,setClientThreadId:t,routeType:s,prefetchSearchPromises:i}){const{createNewThread:r,resetThread:a}=ue({clientThreadId:e,setClientThreadId:t}),{data:l}=Fe(),o=de(l),c=Re(e,P=>P?.modelId),p=pe(),d=o.id,u=c??d,m=me(),h=he(),{isUnauthenticated:T}=Oe(),w=!T,b=fe(e),F=v.useMemo(()=>({clientThreadId:e,currentModelId:u,isModelLoaded:!!c,isEmbeddedInFocusedView:p,isInstalledApp:m,isLoggedInUser:w,focusedObject:h,onNewThread:r,onRequestCompletion:b,resetThread:a,prefetchSearchPromises:i,routeType:s}),[e,u,c,p,m,w,h,r,b,a,i,s]);return L.jsx(ie.Provider,{value:F,children:L.jsx(Mt,{clientThreadId:e,children:n})})}function At(){const{store:n}=ge(),e=ve(),{clearSystemHintModeTrigger:t,getSystemHintModeTrigger:s}=we(),{value:i}=Ke("1988730211"),r=!Se.useDisabledGlobally(),{onRequestCompletion:a}=xt();return v.useCallback((l,o,c,p)=>{const d=n.getSharedProps();if(!d)return;const{clientThreadId:u,onResetState:m,conversationMode:h}=d;ye.hideThreadHeader();const T=e.has(H.Search),w=T?s(H.Search):void 0,b=Le(u),{systemHints:F,extraStreamParams:P}=Me(o)?{systemHints:[o.categoryId],extraStreamParams:o.modelOverride?{model:o.modelOverride}:{}}:i?xe(Array.from(e)):{systemHints:Array.from(e),extraStreamParams:{}};r&&(P.enableMessageFollowups=!0);const j=Te(),G={is_starter_prompt:!0,suggestion_type:o.type,starter_prompt_id:"id"in o?o.id:void 0};j&&(G.__internal={search_settings:j});const re=_e(Ce(o),G);a({promptMessage:re,sourceEvent:l,extraStreamParams:P,completionMetadata:{suggestions:c,suggestion:o,suggestionIndex:p,conversationMode:h??b?.mode,systemHints:F,searchSource:w}});const ae=ze.getCurrentNode(b).message.id;m(),be(o,p,u,ae),Ee()||De(),w&&T&&t(H.Search)},[n,e,s,i,r,a,t])}export{Mt as C,ot as P,It as a,kt as b,yt as c,U as d,xt as e,Pt as f,$ as g,Ht as h,ee as s,At as u};
//# sourceMappingURL=jjqeoesb3rhorlyg.js.map
