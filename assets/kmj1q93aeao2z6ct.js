import{d as q,e as F,r as y,j as e,M as j}from"./khl8ktun31iepecq.js";import{z as N,M as I,V as z,gD as T,ae as Q,aq as H}from"./haannt40upmuwmtk.js";import{gy as U,gx as O,ax as R,ay as V,az as B,aA as W,ck as L,gz as K,gA as X,gw as Z,c9 as J,cl as Y,gB as D}from"./n4exq6o15ap1g74l.js";import{T as $,I as ee}from"./hvdwpbr2ljyv44tg.js";const se=["Not relevant","Inaccurate","Incomplete","Missing sources","I don't like it","Shouldn't have searched Google Drive","Prompt was misunderstood","Didn't like the response style","Other"],te=["Good sources","Answered my question","I like it","Other"],ae=["Not relevant","Out of date","Content is wrong"],ne=["Relevant","Up to date","Accurate"];function re(n){switch(n){case"Not relevant":return u.tagNotRelevant;case"Inaccurate":return u.tagInaccurate;case"Incomplete":return u.tagIncomplete;case"Missing sources":return u.tagMissingSources;case"I don't like it":return u.tagDontLikeIt;case"Shouldn't have searched Google Drive":return u.tagShouldntHaveSearched;case"Prompt was misunderstood":return u.tagPromptMisunderstood;case"Didn't like the response style":return u.tagDidntLikeResponseStyle;case"Other":return u.tagOther;case"Good sources":return u.tagGoodSources;case"Answered my question":return u.tagAnsweredMyQuestion;case"I like it":return u.tagLike;case"Out of date":return u.tagOutOfDate;case"Content is wrong":return u.tagContentWrong;case"Relevant":return u.tagRelevant;case"Up to date":return u.tagUpToDate;case"Accurate":return u.tagAccurate}}function G(n,m){let a;try{a=re(n)}catch{}return a?m.formatMessage(a):n}function E(n,m){return n.map(a=>({label:G(a,m),value:a}))}const u=q({tagNotRelevant:{id:"T24lap",defaultMessage:"Not relevant"},tagInaccurate:{id:"USOv/g",defaultMessage:"Inaccurate"},tagIncomplete:{id:"Lk26Q8",defaultMessage:"Incomplete"},tagMissingSources:{id:"Fng4pl",defaultMessage:"Missing sources"},tagDontLikeIt:{id:"6eAB3A",defaultMessage:"I don't like it"},tagShouldntHaveSearched:{id:"Y22bKM",defaultMessage:"Shouldn't have searched Google Drive"},tagPromptMisunderstood:{id:"NjmgTt",defaultMessage:"Prompt was misunderstood"},tagDidntLikeResponseStyle:{id:"np+P/8",defaultMessage:"Didn't like the response style"},tagOther:{id:"BK4DWm",defaultMessage:"Other"},tagGoodSources:{id:"SpXc0X",defaultMessage:"Good sources"},tagAnsweredMyQuestion:{id:"jbur49",defaultMessage:"Answered my question"},tagLike:{id:"w9iwLl",defaultMessage:"I like it"},tagOutOfDate:{id:"qzHvzr",defaultMessage:"Out of date"},tagContentWrong:{id:"gGDbwI",defaultMessage:"Content is wrong"},tagRelevant:{id:"G4D31U",defaultMessage:"Relevant"},tagUpToDate:{id:"CsRBPs",defaultMessage:"Up to date"},tagAccurate:{id:"ohD9UA",defaultMessage:"Accurate"}});function oe({citationMetadata:n,noBottomBorder:m=!1,sourceFeedback:a,setSourceFeedback:k}){const p=F(),[d,b]=y.useMemo(()=>{if(n.type!=="file")return["",""];const r=n.name.split(".");return r.length>1?[r.slice(0,-1).join("."),r[r.length-1]]:[n.name,""]},[n]),s=y.useMemo(()=>{if(n.type!=="file")return()=>null;const r=n.cloud_doc_url??n.extra?.cloud_doc_url;return r?O(r)?.Icon??(()=>null):U},[n]),l=y.useMemo(()=>{if(n.type==="file"&&n.extra?.cloud_doc_url)try{return new URL(n.extra.cloud_doc_url).hostname}catch{return}},[n]),f=y.useCallback(r=>{k({rating:r,tags:[]})},[k]);return n.type!=="file"?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[e.jsxs("div",{className:"max-width-full me-2 flex grow flex-row items-center overflow-hidden",children:[e.jsx(s,{className:"icon-md me-2 shrink-0 grow-0"}),e.jsx("a",{href:n.extra?.cloud_doc_url,className:"text-token-primary flex-shrink-1 flex-grow-1 overflow-hidden text-sm text-ellipsis whitespace-nowrap",target:"_blank",rel:"noreferrer",children:d}),l&&e.jsx("div",{className:"text-token-text-secondary ms-2 text-sm",children:l})]}),e.jsxs("div",{className:"flex shrink-0 flex-row items-center",children:[e.jsx("button",{className:"hover:bg-token-main-surface-secondary rounded-md p-1",children:a?.rating==="thumbsUp"?e.jsx(R,{className:"icon-md-heavy text-token-text-primary",onClick:()=>f(void 0)}):e.jsx(V,{className:"icon-md-heavy text-token-text-secondary",onClick:()=>f("thumbsUp")})}),e.jsx("button",{className:"hover:bg-token-main-surface-secondary rounded-md p-1",children:a?.rating==="thumbsDown"?e.jsx(B,{className:"icon-md-heavy text-token-text-primary",onClick:()=>f(void 0)}):e.jsx(W,{className:"icon-md-heavy text-token-text-secondary",onClick:()=>f("thumbsDown")})})]})]}),a?.rating&&e.jsx("div",{className:"mb-4 flex flex-row",children:(a.rating==="thumbsDown"?ae:ne).map(r=>e.jsx($,{className:"me-2",$selected:a.tags.includes(r),onClick:()=>k({...a,tags:a.tags.includes(r)?a.tags.filter(g=>g!==r):[...a.tags,r]}),children:G(r,p)},r))}),!m&&e.jsx("div",{className:"border-token-border-default w-full border-[0.5px]"})]})}function le({documentId:n,title:m,externalUrl:a,noBottomBorder:k=!1,shouldHaveBeenIncluded:p,setShouldHaveBeenIncluded:d}){const b=y.useMemo(()=>{const l=a;return l?O(l)?.Icon??(()=>null):U},[a]),s=y.useMemo(()=>{if(a)try{return new URL(a).hostname}catch{return}},[a]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[e.jsxs("div",{className:"max-width-full me-2 flex grow flex-row items-center overflow-hidden",children:[e.jsx(b,{className:"icon-md me-2 shrink-0 grow-0"}),e.jsx("a",{href:a,className:"text-token-primary flex-shrink-1 flex-grow-1 overflow-hidden text-sm text-ellipsis whitespace-nowrap",target:"_blank",rel:"noreferrer",children:m}),s&&e.jsx("div",{className:"text-token-text-secondary ms-2 text-sm",children:s})]}),e.jsx("div",{className:"flex shrink-0 flex-row items-center px-2",children:e.jsx(L,{checked:p,onChange:l=>d?.(l.currentTarget.checked),id:`should-have-been-included-${n}`})})]}),!k&&e.jsx("div",{className:"border-token-border-default w-full border-[0.5px]"})]})}function ie(n,m){const{entireConversation:a,messageId:k}=m;if(!a)throw new Error("The extraction function only supports exporting the entire conversation for now.");let p=k;const d=[];for(;p;){const b=n.getNodeByIdOrMessageId(p);if(!b){p=null;break}const s=b.message;if(!s)continue;const l=K(s)??"",f=Array.isArray(s.metadata?.citations)?s.metadata.citations:[],r=Array.isArray(s.metadata?.attachments)?s.metadata.attachments:[],g={id:String(s.id),author:s.author.role,recipient:s.recipient??"",createTime:s.create_time,updateTime:s.update_time};switch(s.author.role){case N.System:d.push({...g,type:"system",content:s.content,citations:f,attachments:r});break;case N.Assistant:if(s.recipient&&["user","all"].includes(s.recipient)&&l)d.push({...g,type:"visible_text",text:l,citations:f,attachments:r});else if(s.recipient&&s.recipient.includes("file_search")){const h=s.metadata?.command??"";let M=[];try{const v=JSON.parse(l);typeof v=="object"&&v!=null&&Array.isArray(v.queries)&&(M=v.queries.map(_=>String(_)))}catch{}M?d.push({...g,type:"query",command:h,content:s.content,queries:M}):d.push({...g,type:"generic_file_search_tool",command:h,content:s.content})}break;case N.User:(l||r.length>0)&&d.push({...g,type:"visible_text",text:l,citations:f,attachments:r});break;case N.Tool:if(s.author.name?.includes("file_search")&&s.recipient==="all"){const h=s.metadata?.command??"";if(h==="msearch"&&s.content.content_type===I.TetherBrowsingDisplay){const M=s.content.result,v=s.metadata?.cloud_doc_urls;if(M){let _=null;const w=s.metadata?.raw_response;if(typeof w=="object"&&w!=null)try{_=X(w)}catch{}d.push({...g,type:"result",command:h,content:s.content,result:Z(M,v),searchResponse:_})}}else h==="context_stuff"&&s.content.content_type===I.TetherQuote?d.push({...g,type:"fetch",command:h,content:s.content}):d.push({...g,type:"generic_file_search_tool",command:h,content:s.content})}break}p=b.parentId||null}return m.orderRootToLeaf&&d.reverse(),{messages:d}}const ce="considered-source-should-have-been-used";function ge({citations:n,rating:m,onSubmit:a,onCancel:k,messageId:p,conversationId:d,nodeId:b,conversationTree:s}){const l=F(),f=z(),[r,g]=y.useState(""),[h,M]=y.useState(()=>{const t={};for(const i of n)i.metadata?.type==="file"&&(t[i.metadata.id]={rating:void 0,tags:[],url:i.metadata.extra?.cloud_doc_url});return t}),v=s?.getNodeByIdOrMessageId(p).message,_=y.useMemo(()=>{const t=new Set,i=[];for(const c of v?.metadata?.citations??[])!c.metadata||c.metadata.type!=="file"||t.has(c.metadata.id)||(i.push(c.metadata),t.add(c.metadata.id));for(const c of v?.metadata?.content_references??[])if(c.type==="file_navlist")for(const o of c.items)t.has(o.id)||(i.push({type:"file",id:o.id,name:o.name,source:"my_files",text:o.description,cloud_doc_url:o.cloud_doc_url,extra:{cloud_doc_url:o.cloud_doc_url}}),t.add(o.id));return i},[v]),[w,A]=y.useState(!0),S=y.useMemo(()=>{const t={hasQuery:!1,lastAssistantMessage:null,lastUserMessage:null,referencedSyncedFiles:[]};if(!s||!b||!s.containsNodeOrMessageId(b))return t;const i=ie(s,{messageId:b,entireConversation:!0});for(const c of i.messages)switch(c.type){case"fetch":case"generic_file_search_tool":case"system":continue;case"result":{c.result.chunks.forEach(o=>{o.documentId&&!t.referencedSyncedFiles.some(x=>x.fileId===o.documentId)&&!_.some(x=>x.type==="file"&&x.id===o.documentId)&&t.referencedSyncedFiles.push({fileId:o.documentId,title:o.title,url:o.cloudDocUrl})});continue}case"query":{t.hasQuery=!0;continue}case"visible_text":{if(c.author===N.User){if(!t.lastUserMessage){const o=T(s,c.id),x=o[o.length-1].messages,C=x[x.length-1];t.lastUserMessage=C}}else if(c.author===N.Assistant&&!t.lastAssistantMessage){const o=T(s,c.id),x=o[o.length-1].messages,C=x[x.length-1];t.lastAssistantMessage=C,t.lastUserMessage=null}continue}}return t},[s,_,b]),P=y.useCallback(async t=>{const i={...t,additionalSources:r,sourcesFeedback:h,consentedToShareConvoLink:w};try{await Q.submitCaMessageFeedback({feedback_format:J.ALPHA,message_id:p,conversation_id:d,text:i.textFeedback,rating:m,tags:i.tags,tag_choices:i.tagChoices,additional_sources:i.additionalSources,sources_feedback:i.sourcesFeedback,consented_to_share_convo_link:i.consentedToShareConvoLink}),f.success(l.formatMessage({id:"ZzqQBa",defaultMessage:"Thanks for providing feedback!"})),a?.(i)}catch(c){c instanceof H&&f.danger(l.formatMessage({id:"4d5bOS",defaultMessage:"There was an error submitting your feedback. Please try again later."}))}},[r,h,w,p,d,m,f,l,a]);return e.jsxs(ee,{multiple:!0,allowEmptySubmit:!0,onSubmit:P,onCancel:k,tagOptions:E(m==="thumbsDown"?se:te,l),modalOnly:!0,modalTitle:e.jsxs("div",{className:"flex items-center gap-2",children:[m==="thumbsDown"?e.jsx(B,{className:"mb-[-6px]"}):e.jsx(R,{className:"mb-[-6px]"}),e.jsx(j,{id:"h5nasL",defaultMessage:"Provide feedback"})]}),children:[_.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"mt-6 text-base font-semibold",children:e.jsx(j,{id:"G6+7UX",defaultMessage:"Sources"})}),e.jsx("div",{children:_.map((t,i)=>t?.type!=="file"?null:e.jsx(oe,{citationMetadata:t,noBottomBorder:i===_.length-1,sourceFeedback:h[t.id],setSourceFeedback:c=>M(o=>({...o,[t.id]:{...c,url:t.extra?.cloud_doc_url}}))},t.id))})]}),S.referencedSyncedFiles.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-6 flex items-baseline justify-between",children:[e.jsxs("div",{className:"flex-start flex",children:[e.jsx("h3",{className:"text-base font-semibold",children:e.jsx(j,{id:"xvBe/T",defaultMessage:"Considered Sources"})}),e.jsx("p",{className:"text-token-text-secondary ms-2",children:e.jsx(j,{id:"nX81fN",defaultMessage:"({numSources} sources)",values:{numSources:S.referencedSyncedFiles.length}})})]}),e.jsx("p",{className:"text-token-text-tertiary text-sm",children:e.jsx(j,{id:"0+Uivl",defaultMessage:"Good Source?"})})]}),e.jsx("div",{className:"mt-2 max-h-[200px] overflow-auto",children:S.referencedSyncedFiles.map((t,i)=>e.jsx(le,{title:t.title,documentId:t.fileId,externalUrl:t.url,noBottomBorder:i===S.referencedSyncedFiles.length-1,shouldHaveBeenIncluded:!!h[t.fileId],setShouldHaveBeenIncluded:c=>M(o=>{const x={...Object.fromEntries(Object.entries(o).filter(([C])=>C!==t.fileId))};return c&&(x[t.fileId]={tags:[ce],rating:"thumbsUp",url:t.url}),x})},t.fileId))})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("p",{className:"text-token-text-primary text-sm",children:e.jsx(j,{id:"1ApJVo",defaultMessage:"Add any additional sources"})}),e.jsx(Y,{name:"feedback",className:"mt-2",placeholder:l.formatMessage({id:"CAFeedbackModal.additionalSourcePlaceholder",defaultMessage:"(Optional) Additional sources"}),value:r,onChange:t=>g(t.target.value)})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"mb-2 text-base font-semibold",children:e.jsx(j,{id:"9NcQBu",defaultMessage:"Latest Exchange"})}),e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"mb-4",children:[S.lastUserMessage&&e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-token-text-secondary mb-1 ps-4 text-xs",children:e.jsx(j,{id:"QTWrtR",defaultMessage:"Your message"})}),e.jsx("div",{className:"flex justify-start",children:e.jsx("p",{className:"dark:bg-token-main-surface-secondary relative max-w-[var(--user-chat-width,70%)] rounded-3xl bg-[#f4f4f4] px-5 py-2.5",children:S.lastUserMessage?e.jsx(D,{message:S.lastUserMessage,isCompletionInProgress:!1,hasActiveRequest:!1,clientThreadId:d,isFinalUserTurn:!1,isUserTurn:!1,turnIndex:0,isFeedbackEnabled:!1}):null})})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("p",{className:"text-token-text-secondary mb-1 ps-4 text-xs",children:e.jsx(j,{id:"ZCTm4h",defaultMessage:"ChatGPT's response"})}),e.jsx("div",{className:"bg-token-main-surface-secondary relative rounded-lg p-4 text-sm",children:S.lastAssistantMessage?e.jsx(D,{message:S.lastAssistantMessage,isCompletionInProgress:!1,hasActiveRequest:!1,clientThreadId:d,isFinalUserTurn:!1,isUserTurn:!1,turnIndex:1,isFeedbackEnabled:!1}):null})]})]})}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"mt-6 text-base font-semibold",children:e.jsx(j,{id:"c95uEW",defaultMessage:"Full conversation"})}),e.jsx("p",{className:"text-token-text-secondary mt-1 mb-2 text-sm",children:e.jsx(j,{id:"3E3ZSm",defaultMessage:"If previous portions of this conversation are important to understand your feedback, we encourage you to include it."})}),e.jsx(L,{id:"consented-to-share-entire-convo",label:l.formatMessage({id:"5CC8r8",defaultMessage:"Share Entire Conversation"}),checked:w,onChange:t=>{A(t.currentTarget.checked)}})]})]})]})}export{ge as C,ce as a,G as g};
//# sourceMappingURL=kmj1q93aeao2z6ct.js.map
