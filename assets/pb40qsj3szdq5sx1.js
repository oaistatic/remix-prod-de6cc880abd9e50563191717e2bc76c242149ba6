import{r as l,j as c,a8 as w,a9 as Y,e as re}from"./khl8ktun31iepecq.js";import{C as ie}from"./e4mtqust07fsbtad.js";import{aJ as ce,gC as le,hm as ue,hn as de}from"./n4exq6o15ap1g74l.js";import{F as U}from"./jows9759jdyt51hg.js";import{as as b,at as S,a as E,dG as fe,B as V,aG as H,H as G,g as W,L as F,P as Z,dd as me,A as he}from"./haannt40upmuwmtk.js";import{u as pe}from"./kw97lv1qq6sjlhnf.js";import"./jbl38r5yycb2mrt9.js";import"./oyqlb501dhlk5b61.js";import"./dryvpx92fe6zevra.js";import"./b9iv65ef6it0bnl8.js";import"./h1em0bjkpkjv8ykw.js";import"./i3axmsntxbz0hz1f.js";import"./ici1r2pdfnai9c6r.js";import"./kiredz58u04n7vci.js";import"./cv6si9v270pdl3vk.js";import"./mh4bwze9qp65qu97.js";import"./iuzjvviw85b4ghdw.js";import"./miy9m4xp0yschmng.js";import"./dlwdwnl197lh1mf5.js";import"./eiq9v0oy1lyfg3c8.js";import"./dblaaxd78ezocyc0.js";import"./ougcm9i7phfim0kn.js";import"./mr4t2sawqo9d3nrg.js";import"./pc2givv05uuq8g6l.js";import"./gna4hr6ugwtsnaih.js";import"./ctjt1fjp3mtlelcg.js";const N=24,Ce=16,ge=8,O=12,xe=5e3,Te="_markdown_1frq2_10",_e="_fade_1frq2_1",$={markdown:Te,fade:_e},ke=({children:e,onMeasure:n})=>{const[{height:t},a]=le();return fe(()=>{t&&n?.(t)},[t]),c.jsx("div",{className:"flex",ref:a,children:e})};var q=(e=>(e.STATIC="static",e.ENTER="enter",e.STAGE="stage",e))(q||{});const ve=({isAnimationComplete:e=!1,isExpanded:n=!1,isLast:t=!1,index:a,content:s,onClick:u,onMeasure:r,onAnimationComplete:x,showBullet:i=!1})=>{const m=t||n;let h="static",C="static";t&&!e?(h="enter",C="stage"):C="static";const _=l.useRef(null);_.current=()=>{x?.(a,"enter")};const d=l.useCallback(()=>{_.current?.()},[]);l.useEffect(()=>{if(h!=="enter")return;const T=setTimeout(()=>{b.count(S.COT_SUMMARIZER,"cot_chunk_timeout"),_.current?.()},xe);return()=>clearTimeout(T)},[h]);const p=h==="static";return c.jsx(w.div,{role:n?void 0:"button",variants:{static:{opacity:1,scale:1,position:"static",translateY:0},enter:{position:"static",translateY:0,scale:1,opacity:1},stage:{position:"absolute",translateY:-N,scale:.95,opacity:0}},initial:C,animate:h,exit:n?void 0:{opacity:0,pointerEvents:"none",position:"absolute",translateY:N,filter:"blur(8px)"},style:{zIndex:a},transition:e||h==="static"?{duration:0}:{type:"spring",bounce:.05},className:E("text-token-text-secondary top-0 origin-left",!m&&"pointer-events-none"),onAnimationComplete:T=>T!=="enter"&&x(a,T),onClick:u,children:c.jsx(ke,{onMeasure:T=>{r(a,T*(C==="stage"?1/.95:1))},children:c.jsx(ce,{onComplete:d,isDisabled:p,defaultDelayPerSegmentMs:20,children:i?c.jsxs("div",{className:"flex items-start gap-2",children:[c.jsxs("div",{className:"flex h-full w-4 flex-col items-center gap-2 overflow-hidden pt-[7px]",children:[c.jsx("div",{className:"bg-token-icon-secondary h-[6px] w-[6px] shrink-0 rounded-full"}),!t&&c.jsx(w.div,{initial:{translateY:-N,opacity:0},animate:{translateY:0,opacity:1},className:"bg-token-border-medium h-full w-[1px] rounded-full"})]}),c.jsx(U,{className:E($.markdown,"text-token-text-secondary text-sm"),children:s})]}):c.jsx(U,{className:E($.markdown,"text-token-text-secondary"),children:s})})})})},Me=l.memo(ve),ye=(e,n)=>{if(n<=1)return e.formatMessage({id:"ZxhUq1",defaultMessage:"a second"});if(n<3)return e.formatMessage({id:"4GD7tD",defaultMessage:"a couple of seconds"});if(n<4)return e.formatMessage({id:"jx5V1u",defaultMessage:"a few seconds"});if(n>=60){const t=Math.floor(n/60),a=n%60;return`${t}m ${a}s`}return e.formatMessage({id:"p4/pTg",defaultMessage:"{seconds} seconds"},{seconds:n})},Ee=e=>{let n=0;for(const t of e)n+=t.metadata?.finished_duration_sec??0;return n},Re=(e,n,t)=>n.length>1?e.formatMessage({id:"sdDgmZ",defaultMessage:"Thought for {timing}"},{timing:ye(e,t)}):V(n)?.metadata?.finished_text??"";var R=(e=>(e.HEADLINE="headline",e.COT="CoT",e))(R||{});const M=e=>({key:e,type:"CoT",content:"",isComplete:!0}),be=(e,n=!1)=>{const t=[],a=e.split(/( {2}\n)|(\n\n)/).filter(r=>r!=null&&r.trim());if(!n&&a.length<2)return t;let s=M(t.length),u=!1;for(let r=0;r<a.length;r++){const i=a[r].trim();if(i.toLowerCase()==="none"){b.count(S.COT_SUMMARIZER,"num_none_chunks");continue}const m=i.match(/^\*\*(.*)\*\*$/);if(m)s.content.trim()&&(s.isComplete=!0,t.push(s),s=M(t.length)),t.push({key:t.length,type:"headline",content:m[1]??"",isComplete:!0}),s=M(t.length);else if(i){if(i.startsWith("```"))if(!u)s.isComplete=!0,t.push(s),s=M(t.length),u=!0;else{s.content+=s.content?`
${i}`:i,s.isComplete=!0,t.push(s),s=M(t.length),u=!1;continue}s.content.trim()&&!i.startsWith("\\[")&&!i.startsWith("\\(")&&!u&&(s.isComplete=!0,t.push(s),s=M(t.length)),s.content+=s.content?`
${i}`:i,s.isComplete=!1}}return s.content.trim()&&(s.isComplete=n,t.push(s)),t},Se=(e,n)=>{const t=!n,a=l.useMemo(()=>be(e,t),[e,t]);return l.useEffect(()=>{t&&b.hist(S.COT_SUMMARIZER,"num_cot_chunks",void 0,a.length)},[t]),{chunks:a,isComplete:t}},z=({type:e,isComplete:n})=>e===R.HEADLINE&&n,Ne={duration:.3,ease:"easeInOut"},we=({isStreaming:e=!1,expandByDefault:n=!1,finishedText:t,summaryText:a,onAnimationComplete:s})=>{const{chunks:u,isComplete:r}=Se(a,e),[x,i]=l.useState(()=>new Map),{value:m}=H("1099124727"),h=G(u,({type:o})=>o===R.COT)?.key??null,[C,_]=l.useState(()=>e?null:h),d=r&&C===h,[p,T]=l.useState(()=>{const o=W.getItem(F.ExpandSummarizedCoT);return e?o!=null?!!o:n:!1}),A=l.useCallback((o,f)=>{T(o),e&&W.setItem(F.ExpandSummarizedCoT,o),b.count(S.COT_SUMMARIZER,o?"expand":"collapse",[{key:"is_streaming",value:String(e)},{key:"source",value:f}]),Z.logEventWithStatsig(o?"CoT Expanded":"CoT Collapsed",o?"chatgpt_cot_expanded":"chatgpt_cot_collapsed",{is_streaming:String(e),source:f})},[e]),k=l.useMemo(()=>{const o=[];for(let f=0;f<u.length;f++){const g=u[f];g.type===R.COT&&g.content&&g.isComplete&&o.push(f)}return o.find((f,g)=>C==null||f>C||g===o.length-1)??-1},[u,C]),X=l.useCallback((o,f)=>{i(g=>{const P=new Map(g);return P.set(o,f),P})},[]),J=l.useCallback(()=>{A(!0,"chunk")},[A]),I=Array.from(x.values()),y=u.slice(0,k+1),Q=(G(y,z)??u.find(z))?.content;let v=y.filter(o=>o.type===R.COT);p||(v=v.slice(-1));const j=l.useRef(null);pe(k);const D=()=>{if(j.current!=null){const o=performance.now()-j.current;b.hist(S.COT_SUMMARIZER,"cot_chunk_display_time",void 0,o)}};l.useEffect(()=>{if(d)return D();k!==-1&&(D(),j.current=performance.now())},[k]),l.useEffect(()=>{d||k<0||Z.logEventWithStatsig(p?"Streamed CoT Chunk Viewed":"Streamed CoT Chunk Ignored",p?"chatgpt_streamed_cot_chunk_viewed":"chatgpt_streamed_cot_chunk_ignored")},[k,d,p,e]);const ee=l.useCallback((o,f)=>{f===q.ENTER&&(_(g=>g!=null?Math.max(g,o):o),r&&o===h&&s?.())},[r,h,s]);l.useEffect(()=>{if(r&&!d){T(!1),_(h),s?.();return}!r||!d||v.length||s?.()},[r,d,v]);const te=y.length>0&&(!d||p),L=m?ge:Ce,ne=ue(I)+(I.length-1)*L+2*O,se=d?"auto":p?ne:(V(I)??0)+2*O,oe=y.length===0||!r&&y.length<2,ae=m&&e?{initial:{opacity:0,scale:.5,originX:0,originY:0},animate:{opacity:1,scale:1},transition:{ease:"easeInOut",duration:.2}}:{};return c.jsxs(w.div,{className:E("my-1 flex flex-col overflow-hidden",m&&"bg-token-background-primary border-token-border-default mb-5 rounded-[20px] border px-5 py-4",m&&e&&!p&&"shadow-token-sidebar-surface-secondary shadow-lg"),...ae,children:[c.jsx(ie,{activeHeadline:Q,finishedText:t,onToggleExpanded:()=>A(!p,"header"),isExpanded:p,isExpandDisabled:oe,isComplete:d}),c.jsx(Y,{children:te&&c.jsxs(w.div,{className:E("relative z-0 whitespace-pre-wrap",!m&&"ps-4 md:ps-7"),initial:d?{opacity:0,height:0,overflowY:"hidden"}:!1,animate:{opacity:1,height:se},exit:{height:0,opacity:0,pointerEvents:"none",overflowY:"hidden",filter:d?"blur(8px)":void 0,translateY:-N},transition:Ne,children:[!m&&c.jsx("div",{className:"bg-token-border-default absolute start-0 top-4 bottom-4 w-1 rounded-full"}),c.jsx("div",{className:"relative flex h-full flex-col",style:{gap:L,margin:`${O}px 0`},children:c.jsx(Y,{children:v.map(({content:o,key:f},g)=>c.jsx(Me,{index:f,content:o,isLast:v.length-1===g,onClick:J,onAnimationComplete:ee,onMeasure:X,isAnimationComplete:d,isExpanded:p,showBullet:m&&p},f))})})]})})]})},Ae=8,rt=({messages:e,isStreaming:n,clientThreadId:t,turnIndex:a})=>{const s=re(),{value:u}=H("1214379119"),{value:r}=H("2968810397"),x=Ee(e),{summaryText:i,contentReferences:m}=Ie(e),h=m.length,{processedText:C,displayedContentReferences:_}=l.useMemo(()=>r?me(i,m,void 0,!1,n):{processedText:i,displayedContentReferences:[]},[i,h,n,r]);if(u&&!n&&!C&&x<Ae)return null;const d={turnIndex:a,clientThreadId:t,messageId:e[0].id};return c.jsx(de.Provider,{value:{analyticsMetadata:d,clientThreadId:t,message:e[0],contentReferences:_,onShowSearchResults:()=>{},isActivelyStreaming:n,useSafeUrls:!0},children:c.jsx(we,{expandByDefault:!1,finishedText:Re(s,e,x),summaryText:C,isStreaming:n})})},K=`

`,B="sonic_browser_tool",Ie=e=>{let n="";const t=[];let a=0;return e.forEach((s,u)=>{if(s.metadata?.cot_tool===B&&e[u+1]?.metadata?.cot_tool===B)return;const r=he(s);n+=n?K+r:r;const x=s.metadata?.content_references?.map(i=>({...i,start_idx:a+i.start_idx,end_idx:a+i.end_idx}))??[];a+=r.length+K.length,t.push(...x)}),{summaryText:n,contentReferences:t}};export{we as CoT,rt as CoTMessage};
//# sourceMappingURL=pb40qsj3szdq5sx1.js.map
